<!doctype html>
<html>
	<head>
		<meta charset="utf-8"/>
		<script src="wasm_exec.js"></script>
		<meta charset='utf-8'>
		<title>K Language Playground - The K Programming Language</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">

        <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
        <script language="javascript" type="text/javascript" src="syntax.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css">
	</head>

	<body onload="init()" style="margin-top: 0;">
		<div style="display: flex; gap:12px; align-items: center; flex-wrap: wrap; margin-top: 1em;">
			<h1 style="margin-block: 0;">The <font style="font-style: italic;">K Language</font> Playground</h1>
			<p style="margin-block: 0;;" id="loadStatusLbl">Unknwon</p>
			<button id="runCodeBtn" onclick="runCodeEvent()">Run</button>
			<button id="fmtBtn" onclick="fmt()">Format</button>
            <button id="reloadCoreBtn" onclick="reloadCore()">Reload Core</button>
			<select id="sampleCodeSelect">
				<option value="helloworld">HelloWorld</option>
				<option value="loop">Loop</option>
				<option value="fib">Fib</option>
			</select>
			<pre style="margin: 0; text-wrap: wrap;" id="infoTxt"></pre>
		</div>
        <div style="border:1px solid black; margin-top: 1em;">
		    <textarea id="codeTxt" style="width: 100%; height: 50vh; font-family: monospace;"></textarea>
        </div>
		

		<pre id="codeResult"></pre>

		<hr style="width: 100%;">
		<div style="display: flex; align-items:bas; gap: 10px; flex-wrap: wrap;">
			<span>Final Year Project<br>xxs166#student.bham.ac.uk<br>B.Sc. Computer Science</span>
			<span>Built on Go, Antlr4, WebAssembly<br>Copyright &copy; 2024 xxs#student.bham.ac.uk</span>
		</div>

		<script>
			const go = new Go();
			let loaded = false;

            const editor = CodeMirror.fromTextArea(document.getElementById('codeTxt'), {
                lineNumbers: true,
                mode: 'text/x-k',
                theme: 'default',
                indentUnit: 4,
            });
			
			function status(v) {
				document.getElementById("loadStatusLbl").innerHTML = v
			}
			function init(){
				sampleCode(null)
				document.getElementById("sampleCodeSelect").onchange = sampleCode
				loadCore(false)
        	}

			function reloadCore() {
				loadCore(true)
			}
            
            function loadCore(rand) {
				document.getElementById('infoTxt').innerHTML = ''
                status('Loading')
				const tail = rand ? "?ignore=" +  Math.floor(Math.random() * 10000) : ""
				WebAssembly.instantiateStreaming(fetch("core.wasm"+tail), go.importObject).then((result) => {
					go.run(result.instance);
					status('Ready')
					loaded = true
					document.getElementById('infoTxt').innerHTML = infoX()
				}).catch((e) => {
					document.getElementById('codeResult').innerHTML = "LOADER FATAL:\n"+e;
					status('FATAL')
				});
            }

			function setCodeTxt(v) {
				// document.getElementById("codeTxt").innerHTML = v
                editor.setValue(v)
			}

			async function setResult(v) {
				document.getElementById('codeResult').innerHTML = v
				await delay(1)
			}
			
			function setResultSync(v) {
				document.getElementById('codeResult').innerHTML = v
			}
			

			function fmt() {
                const code = editor.getValue()
                setCodeTxt(fmtCodeX(code))
			}

			function sampleCode(e) {
				const code = !e ? 'helloworld' :  e.target.value
				switch (code) {
					case 'helloworld':
						setCodeTxt('println("Hello World!")')
						break
					case 'loop':
						setCodeTxt(
							`for (i : range(5)) {
    i = i + 1
    for (j : range(i)) {
        print("*")
    }
    println()
}
`
						)
						break
					case 'fib':
						setCodeTxt(`fn fib(n) {
    if (n == 0) {
        return 0
    }
    if (n == 1) {
        return 1
    }
    return fib(n - 1) + fib(n - 2)
}

println(fib(5))`)
				}
			}

			async function delay(ms) {
				await new Promise(r => setTimeout(r, ms));
			}

			async function runCodeEvent() {
				if (!loaded) {
					document.getElementById('codeResult').innerHTML = 'Core Language Not Loaded'
					return
				}
				const codeTxt = editor.getValue()
				status('Running')
				await setResult('')
				runCodeStreamX(codeTxt, setResultSync);
                status('Ready')
			}
		</script>
	</body>
</html>