<!doctype html>
<html>
	<head>
		<meta charset="utf-8"/>
		<script src="wasm_exec.js"></script>
		<meta charset='utf-8'>
		<title>K Language Playground - The K Programming Language</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">

        <script language="javascript" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.js"></script>
        <script language="javascript" type="text/javascript" src="syntax.js"></script>
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/6.65.7/codemirror.min.css"></link>
	</head>

	<body onload="init()" style="margin-top: 0;">
		<div style="display: flex; gap:12px; align-items: center; flex-wrap: wrap;">
			<h1 style="margin-block: 0;">The <font style="font-style: italic;">K Language</font> Playground</h1>
			<p id="loadStatusLbl">Unknwon</p>
			<button id="runCodeBtn">Run</button>
			<button id="fmtBtn">Format</button>
			<select id="sampleCodeSelect">
				<option value="helloworld">HelloWorld</option>
				<option value="loop">Loop</option>
				<option value="fib">Fib</option>
			</select>
			<pre style="margin: 0; text-wrap: wrap;" id="infoTxt"></pre>
		</div>
        <div style="border:1px solid black;">
		    <textarea id="codeTxt" style="width: 100%; height: 50vh; font-family: monospace;"></textarea>
        </div>
		

		<pre id="codeResult"></pre>

		<hr style="width: 100%;">
		<div style="display: flex; align-items:bas; gap: 10px; flex-wrap: wrap;">
			<img style="height: 50px;" src="https://upload.wikimedia.org/wikipedia/en/5/5d/Birmingham_logo.svg">
			<span>Final Year Project<br>xxs166#student.bham.ac.uk<br>B.Sc. Computer Science</span>
			<span>Built on Go, Antlr4, WebAssembly<br>Copyright &copy; 2024 xxs#student.bham.ac.uk</span>
		</div>

		<script>
			const go = new Go();
			let loaded = false;

            const editor = CodeMirror.fromTextArea(document.getElementById('codeTxt'), {
                lineNumbers: true,
                mode: 'text/x-k',
                theme: 'default',
                indentUnit: 4,
            });

			function status(v) {
				document.getElementById("loadStatusLbl").innerHTML = v
			}
			function init(){
                
            	document.getElementById("runCodeBtn").onclick = runCodeEvent;
				setCodeTxt('println("Hello World!")')
				document.getElementById("fmtBtn").onclick = fmt
				document.getElementById("sampleCodeSelect").onchange = sampleCode
				status('Loading')
				WebAssembly.instantiateStreaming(fetch("core.wasm"), go.importObject).then((result) => {
					go.run(result.instance);
					status('Ready')
					loaded = true
					document.getElementById('infoTxt').innerHTML = infoX()
				}).catch((e) => {
					document.getElementById('codeResult').innerHTML = "LOADER FATAL:\n"+e;
					status('FATAL')
				});
        	}

			function setCodeTxt(v) {
				// document.getElementById("codeTxt").innerHTML = v
                editor.setValue(v)
			}

			function fmt() {
                const code = editor.getValue()
                setCodeTxt(fmtCodeX(code))
			}

			function sampleCode(e) {
				const code = e.target.value
				switch (code) {
					case 'helloworld':
						setCodeTxt('println("Hello World!")')
						break
					case 'loop':
						setCodeTxt(
							`for (i : range(5)) {
    i = i + 1
    for (j : range(i)) {
        print("*")
    }
    println()
}
`
						)
						break
					case 'fib':
						setCodeTxt(`fn fib(n) {
    if (n == 0) {
        return 0
    }
    if (n == 1) {
        return 1
    }
    return fib(n - 1) + fib(n - 2)
}

println(fib(5))`)
				}
			}

			function runCodeEvent() {
				if (!loaded) {
					document.getElementById('codeResult').innerHTML = 'Core Language Not Loaded'
					return
				}
				status('Running')
				document.getElementById('codeResult').innerHTML = '';
				const codeTxt = editor.getValue()
				const codeR = runCodeX(codeTxt);
                status('Ready')
			    document.getElementById('codeResult').innerHTML = codeR;
			}
		</script>
	</body>
</html>